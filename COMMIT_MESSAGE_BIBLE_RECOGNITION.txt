feat: Implement comprehensive Bible verse recognition system in core engine

This commit introduces a complete Bible reference detection system integrated
into the core engine, enabling real-time detection of Bible verse references
during live transcription and translation sessions.

## Architecture Overview

The system follows a hybrid detection approach combining fast regex pattern
matching with AI-based verse matching for paraphrased references. The design
is mode-agnostic (works in both solo and host modes) and follows the existing
core engine pattern for consistency.

### Detection Pipeline

1. **Normalization Layer** - Normalizes transcript text (lowercase, tokenize,
   parse spoken numbers)
2. **Explicit Reference Detection** - Fast regex matching for explicit
   references (e.g., "Acts 2:38")
3. **Chapter-Only Detection** - Detects chapter references and uses AI to
   match specific verses
4. **AI-Based Matching** - GPT-4o-mini for paraphrased/heavy context
   references
5. **Confidence Scoring** - Contextual boosts and threshold filtering
6. **Event Emission** - Emits SCRIPTURE_DETECTED events with structured
   references

## Core Components Created

### Core Services (`core/services/`)

- **bibleReferenceDetector.js** (828 lines)
  - Main detection engine combining regex and AI strategies
  - Handles explicit references, chapter-only references, and paraphrased
    references
  - Implements confidence scoring and contextual boosts
  - Uses GPT-4o-mini for AI-based matching (no rate limiting needed)

- **bibleReferenceNormalizer.js**
  - Normalizes transcript text for matching
  - Tokenization, lemmatization, spoken number parsing
  - Prepares text for pattern matching

- **spokenNumberParser.js**
  - Parses spoken numbers ("thirty eight" → 38)
  - Supports compound numbers and ordinal detection
  - Essential for detecting references like "Acts chapter two verse thirty
    eight"

- **bookNameDetector.js**
  - Detects Bible book names with alias support
  - Handles canonical names and common variations
  - Supports ordinal books (1 Corinthians, 2 Peter, etc.)

- **bibleVerseFingerprints.js**
  - Manages verse keyword fingerprints (deprecated in favor of AI matching)
  - Maintained for backward compatibility
  - Can be expanded for future optimizations

### Core Engine Integration (`core/engine/`)

- **bibleReferenceEngine.js** (132 lines)
  - Main orchestrator for Bible reference detection
  - Mode-agnostic design (works in solo and host modes)
  - Manages transcript windowing for context
  - Follows existing core engine patterns

- **coreEngine.js** (updated)
  - Integrated BibleReferenceEngine as a core component
  - Added `detectReferences()` method
  - Maintains consistency with other core engines

### Data Files (`core/data/`)

- **contextTriggers.js**
  - Defines contextual trigger phrases ("the Bible says", "as it is written")
  - Used for confidence boosting when detected

- **verseFingerprints.json**
  - MVP verse fingerprints (5 verses)
  - Deprecated but maintained for compatibility
  - Can be expanded for future keyword-based optimizations

### Event System (`core/events/`)

- **eventTypes.js** (updated)
  - Added `SCRIPTURE_DETECTED` event type
  - Defines structured event format for scripture detection

## Backend Integration

### Solo Mode (`backend/soloModeHandler.js`)
- Integrated detection on final transcripts (lines 606-633)
- Non-blocking async detection (doesn't delay transcript delivery)
- Emits `scriptureDetected` WebSocket events
- Fail-safe error handling (fails silently)

### Host Mode (`backend/hostModeHandler.js`)
- Integrated detection with broadcast to listeners (lines 644-673)
- Same non-blocking architecture as solo mode
- Broadcasts detected references to all connected listeners
- Maintains session state for reference tracking

## Detection Features

### 1. Explicit Reference Detection (High Confidence ≥0.85)
- Detects: "Acts 2:38", "Acts chapter two verse thirty eight"
- Uses regex patterns with spoken number parsing
- Fast path: 0 AI calls for explicit references (~70-80% of cases)
- Performance: ~2-8ms per transcript

### 2. Chapter-Only Reference Detection (Regex + AI)
- Detects: "Acts 2" (chapter without verse)
- Regex detects chapter (confidence 0.75)
- AI matches to specific verse based on context
- Example: "In Acts 2, Peter said to repent" → Acts 2:38
- Performance: ~1.5-2s (includes AI latency)

### 3. AI-Based Verse Matching (Primary Method for Non-Explicit)
- Uses GPT-4o-mini for paraphrased references
- Handles heavy context and theological themes
- Example: "repent and be baptized" → Acts 2:38
- No rate limiting (Bible detection is infrequent)
- Validates all AI output with confidence thresholds
- Performance: ~1.5-2s per detection

### 4. Contextual Confidence Boosts
- Detects trigger phrases: "the Bible says", "as it is written", "Peter said"
- Boosts candidate confidence by +0.05
- Helps reduce false negatives

### 5. Non-Blocking Architecture
- Detection runs asynchronously
- Never delays transcript delivery
- Fail-safe: errors don't break transcription/translation
- Runs in parallel with grammar correction and translation

## Testing Infrastructure

### Comprehensive Test Suite (`backend/test-bible-full.js`)
- 19/19 tests passing (100%)
- Tests all components: number parsing, book detection, normalization,
  detection engine, AI matching, core engine integration
- Includes 4 AI tests (require OPENAI_API_KEY from .env)
- Performance: ~5-6 seconds total (AI tests take 1-2s each)

### Component Tests (`backend/test-bible-components.js`)
- Individual component testing
- Validates each service independently

### AI Test Results
- ✅ "repent and be baptized" → Acts 2:38 (AI, confidence: 0.91)
- ✅ "God so loved the world" → John 3:16 (AI, confidence: 0.95)
- ✅ "wages of sin is death" → Romans 6:23 (AI, confidence: 0.95)
- ✅ "In Acts 2, Peter said..." → Acts 2:38 (regex+ai, confidence: 0.91)

## Event Structure

Current event format (emitted via WebSocket):
```json
{
  "type": "scriptureDetected",
  "reference": {
    "book": "Acts",
    "chapter": 2,
    "verse": 38
  },
  "displayText": "Acts 2:38",
  "confidence": 0.90,
  "method": "regex",
  "timestamp": 1234567890,
  "seqId": 42
}
```

## Performance Characteristics

### AI Call Frequency
- Most transcripts: **0 AI calls** (no references or explicit references)
- Chapter-only references: **1 AI call** per detection
- Paraphrased references: **1 AI call** per detection
- Average per sermon: 2-5 AI calls (depending on number of references)

### Detection Speed
- Explicit references: ~2-8ms (regex only)
- Chapter-only/paraphrased: ~1.5-2s (includes AI latency)
- Regex handles ~70-80% of explicit references without AI

### Cost Efficiency
- AI calls: ~$0.0001-0.0003 per detection
- Most references handled by fast regex path (0 AI calls)
- No rate limiting needed (Bible detection is infrequent)

## Current Limitations & Future Work

### Completed (70% of feature)
- ✅ Detection engine (regex + AI)
- ✅ Core engine integration
- ✅ Backend integration (solo + host modes)
- ✅ Event emission with reference structure
- ✅ Comprehensive test suite
- ✅ Non-blocking architecture

### Not Yet Implemented (30% remaining)
- ❌ **Real-time detection on partial transcripts** (currently only final
  transcripts)
  - High priority: Detect immediately as speaker talks
  - Requires deduplication logic and provisional detection system

- ❌ **Bible API integration** (fetch canonical verse text)
  - Critical: Respects theological principle - Scripture must come from
    canonical source
  - Recommended: bible-api.com or API.Bible
  - Needs: Caching layer (24-72 hour TTL)

- ❌ **Frontend UI components**
  - No React components to display detected references
  - No WebSocket message handlers for scripture events
  - No scripture state management

## Design Principles

1. **Theological Accuracy**: Never uses STT/translation as Scripture text
   (canonical text must come from Bible API)

2. **UI-Agnostic**: Backend emits semantic events, not UI decisions
   (transferable to different UI patterns)

3. **Non-Intrusive**: Detection runs async, never blocks transcript delivery

4. **Fail-Safe**: Errors don't break transcription/translation pipeline

5. **Mode-Agnostic**: Single implementation works in both solo and host modes

## Documentation

Comprehensive documentation added:
- `BIBLE_VERSE_RECOGNITION_STATUS.md` - Current status and implementation plan
- `BIBLE_DETECTION_ENGINE_FLOW_EXPLAINED.md` - Detailed flow explanation
- `BIBLE_REFERENCE_TEST_RESULTS.md` - Test results and instructions
- `BIBLE_AI_BASED_VERSE_MATCHING_IMPLEMENTATION.md` - AI matching details

## Breaking Changes

None - this is a new feature addition with no breaking changes to existing
functionality.

## Migration Notes

No migration required. The feature is opt-in and doesn't affect existing
transcription/translation functionality. Detection runs in parallel and fails
silently if errors occur.

## Testing

Run comprehensive test suite:
```bash
cd backend
node test-bible-full.js
```

Requires `OPENAI_API_KEY` in `backend/.env` for AI tests (gracefully skips
if not present).

## Related Issues

- Implements Bible verse recognition as core engine component
- Enables real-time scripture detection during live translation
- Foundation for future Bible API integration and frontend UI

---

**Status**: Core detection engine complete and tested (19/19 tests passing)
**Next Steps**: Real-time partial transcript detection, Bible API integration,
Frontend UI components
